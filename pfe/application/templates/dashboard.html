{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <link rel="stylesheet" href="{% static 'css/newglobal.css' %}" />
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <div class="dashboard">
      <img class="back" style="height: 990px; width: 1490px;" alt="" src="{% static 'images/finale_img.png'%}" />

      <div class="divglobale">
        <div class="trait1">
          <a class="div1" style="color:white;" href="traitement_mansuel">
            <img
              class="img1"
              alt=""
              src="{% static 'images/traitement-de-linformation (1).png'%}"
            />

            <div class="traitement-mansuelle11">Traitement Mansuelle</div>
          </a>
          <a class="affichage"  style="color:white;" href="traitement_p1">
            <div class="affichage2">
              <p class="affichtext">Affichage Bilan</p>
              <p class="affichtext">par périmetre</p>
            </div>
            <img class="icon" alt="" src="{% static 'images/bilan.png'%}" />
         </a>
          <a class="affichage-annuel" href="traitement_annuel">
            <div class="affichage-annuel1">Affichage Annuel</div>
            <img
              class="imageannuel"
              alt=""
              src="{% static 'images/traitement-de-linformation.png'%}"
            />
          </a>
          <a class="dash" href="dashboard">
            <div class="dash1">Dashboard</div>
            <img
              class="dash2"
              alt=""
              src="{% static 'images/tabelu de bord.png'%}" 
            />
          </a>
          <b class="menu">Menu</b>
          <div class="div2"></div>
          <div class="div3"></div>
        </div>
      </div>
      <a class="acceuil" href="login">
        <b class="deconnecte">se déconnecter</b>
      </a>
      <div class="rectangle-blanc" ></div>

      <a href="acceuil">
        <img class="logo" alt="Description de l'image" src="{% static 'images/logo.png' %}">
      </a>
    
      <div class="dashboard-pie">
        <canvas id="pie-chart"></canvas>
      </div>
      <div class="dashboard-bar">
        <canvas id="bar-chart"></canvas>
      </div>
      <div class="dashboard-line">
        <canvas id="line-chart"></canvas>
      </div>
      <form id="excelForm"  action="{% url 'application:generate_excel_from_extract' %}" method="POST">
        {% csrf_token %}
        <input type="hidden" name="dateDebut" id="excelDateDebut">
        <input type="hidden" name="dateFin" id="excelDateFin">
        <input type="hidden" name="region" id="excelRegion">
        <input type="hidden" name="error" id="excelError" value="{% if error %}{{ error }}{% endif %}">  
        <button class="donnee" type="submit">
          <img class="icon-pdf" alt="" src="{% static 'images/icon-excel .png' %}" />
          <span>EXCEL</span> 
        </button>
      </form>    
      <form class="form" id="chartForm" action="{% url 'application:get_chart_data' %}" method="POST">
        {% csrf_token %}
        
        <input class="div4" value="{{ dateFin }}" type="month" id="dateFin" name="dateFin" required>
        
        <select name="region" id="region" class="div5" required>
            <option class="rgion1" value="">Région</option>
            <option value="Stah" class="option" {% if region == "Stah" %}selected{% endif %}>Stah</option>
            <option value="Adrar" class="option" {% if region == "Adrar" %}selected{% endif %}>Adrar</option>
            <option value="In Amenas" class="option" {% if region == "In Amenas" %}selected{% endif %}>In Amenass</option>
            <option value="Hassi Messaoud" class="option" {% if region == "Hassi Messaoud" %}selected{% endif %}>Hassi Messaoud</option>
        </select>
    
        <input class="div6" value="{{dateDeb}}" type="month" id="dateDebut" name="dateDebut" required>
        <b for="dateDebut" class="date-dbut1">Date de début:</b>
        <b class="date-fin1">Date fin:</b>
        <button class="button" type="submit" id="submitBtn"> 
          <i class="fa-solid fa-check" style="color:gray"></i>
        </button>
    </form> 
    
      </div>
    </div>
  </body>
  <script>
    var data = {{data_pie_chart | safe}}
var labels = data.map(function(item) { return item.perimetre; });
var percentages = data.map(function(item) { return parseFloat(item.percentage); });
    var data2 = {{productionPrev | safe}}
var labels2 = data2.map(function(item) { return item.perimetre; });

var Production = data2.map(function(item) { return (item.production_mensuelle); });
var Prévision = data2.map(function(item) { return (item.prevision); });

  var data3 = {{production_previsions_mois | safe}}
var labels3 = data3.map(function(item) { return item.mois; });
var Production3 = data3.map(function(item) { return (item.production_mensuelle); });
var Prévision3 = data3.map(function(item) { return (item.prevision); });
      new Chart("pie-chart", {
          type: 'pie',
          data: {
              labels: labels,
              datasets: [{
                  data:percentages,
                  backgroundColor: [
                      'rgba(196, 196, 196,1)',
                      'rgba(250, 140, 0, 1)',
                      'rgba(21, 96, 122,1)',
                      'rgba(143, 27, 17, 1)',
                      'rgba(255, 213, 45, 1)',
                      'rgba(255, 202, 118, 1)',
                  ],
                  borderColor: [
                      'rgba(196, 196, 196,1)',
                      'rgba(250, 140, 0, 1)',
                      'rgba(21, 96, 122,1)',
                      'rgba(143, 27, 17, 1)',
                      'rgba(255, 213, 45, 1)',
                      'rgba(255, 202, 118, 1)',
                  ],
                  borderWidth: 1
              }]
          },
          options: {
              title: {
                  display: true,
                  text: 'Production par périmètre'
              }
          }
      });
  


      new Chart("bar-chart", {
          type: 'bar',
          data: {
              labels: labels2,
              datasets: [{
                  label: "Production",
                  data: Production,
                  backgroundColor: 'rgba(250, 140, 0, 1)',
                  borderColor: 'rgba(250, 140, 0, 1)',
                  borderWidth: 1
              }, {
                  label: "Prevision",
                  data: Prévision,
                  backgroundColor: 'rgba(21, 96, 122, 1)',
                  borderColor: 'rgba(21, 96, 122, 1)',
                  borderWidth: 1
              }]
          },
          options: {
              title: {
                  display: true,
                  text: 'Production par périmètre et mois'
              },
              scales: {
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });
      new Chart("line-chart", {
    type: 'line',
    data: {
        labels: labels3.map(function(month) {
            // Formatage des mois, par exemple: "Jan 2024"
            return new Date(month + '-01').toLocaleString('default', { month: 'short'});
        }),
        datasets: [{
            label: 'Production',
            data: Production3,
            backgroundColor: 'rgba(21, 96, 122, 1)',
            borderColor: 'rgba(21, 96, 122, 1)',
            borderWidth: 1
        }, {
            label: 'Prévision',
            data: Prévision3,
            backgroundColor: 'rgba(250, 140, 0, 1)',
            borderColor: 'rgba(250, 140, 0, 1)',
            borderWidth: 1
        }]
    },
    options: {
        title: {
            display: true,
            text: 'Évolution de la production et prévision'
        },
        maintainAspectRatio: false, // Permet au graphique de s'adapter à la largeur du conteneur
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Mois'
                }
            },
            y: {
                beginAtZero: true
            }
        }
    }
});

      
    document.getElementById('submitBtn').addEventListener('click', function(event) {
        const dateDebutInput = document.getElementById('dateDebut');
        const dateFinInput = document.getElementById('dateFin');
        const regionSelect = document.getElementById('region');

        if (dateDebutInput.value === "" || dateFinInput.value === "" || regionSelect.value === "") {
            event.preventDefault(); // Empêcher la soumission du formulaire
            alert("Veuillez sélectionner une date de début, une date de fin et une région."); // Afficher une alerte
        }
    });
    document.addEventListener("DOMContentLoaded", function() {
    const chartForm = document.getElementById("chartForm");
    const excelForm = document.getElementById("excelForm");
    const excelButton = document.querySelector("#excelForm button[type='submit']");
    const errorInput = document.getElementById("excelError"); // Récupérer le champ caché

    if (chartForm && excelForm && excelButton) {
        excelButton.addEventListener("click", function(event) {
            event.preventDefault();

            // Récupérer les valeurs du formulaire "chartForm"
            const chartDateDebut = chartForm.querySelector("#dateDebut").value;
            const chartDateFin = chartForm.querySelector("#dateFin").value;
            const chartRegion = chartForm.querySelector("#region").value;

            // Vérification des champs requis (date de début, date de fin, région)
            if (!chartDateDebut || !chartDateFin || chartRegion === "") {
                alert("Veuillez sélectionner une date de début, une date de fin et une région.");
                return;
            }

            // Mettre à jour les champs cachés du formulaire "excelForm"
            excelForm.querySelector("#excelDateDebut").value = chartDateDebut;
            excelForm.querySelector("#excelDateFin").value = chartDateFin;
            excelForm.querySelector("#excelRegion").value = chartRegion;

            // Soumettre le formulaire "excelForm" directement
            excelForm.submit(); 
        });

        // Vérification du message d'erreur (après la soumission du formulaire)
        if (errorInput && errorInput.value) {
            alert(errorInput.value);
            errorInput.value = ""; // Effacer le message d'erreur après l'avoir affiché
        }
    } else {
        console.error("Un ou plusieurs formulaires requis sont manquants.");
    }
});



</script>
</html>