{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
    <link rel="stylesheet" href="{% static 'css/page2.css' %}" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap"
    />
  </head>
  <style>
    .choose-file-button {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
}

.choose-file-label {
  position: absolute;
  font-size: 50px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  height: 100%;
  padding: 10px;
  box-sizing: border-box;
  background-color: transparent;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  text-align: center;
  cursor: pointer;
}

.choose-file-button:invalid + .choose-file-label:before {
  content: "Choisir fichier";
}

.choose-file-button:valid + .choose-file-label:before {
  content: attr(data-file-name);
}

.choose-file-button:valid + .choose-file-label:after {
  content: "Fichier sélectionné";
  color: #007bff;
}

.choose-file-button::-webkit-file-upload-button {
  display: none;
}
  </style>
  <body>
    <div class="page2">
      <img class="page2-child" alt="" src="{% static 'images/Desktop - 1.png'%} "/>

      <div class="group1">
        <div class="clip-path-group">
          <img class="group-icon1" alt="" src="{% static 'images/logo.png'%} "/>
        </div>
      </div>
      <div class="page2-item" ></div>

      <a class="acceuil-wrapper" href="acceuil">
        <b class="acceuil">Acceuil</b>
      </a>
      <form method="post" enctype="multipart/form-data" id="file-upload-form" action="{% url 'application:upload_file' %}">
        {% csrf_token %}
        <div class="page2-inner">
            <label class="choose-file-label" for="file">Choisir fichier</label>
            <input type="file" name="file" class="choose-file-button">
            <br><br>
        </div>
        <div class="frame-div"></div>
        <button class="rectangle-div" id="upload-button" type="submit">
            <b class="ok">OK</b>
        </button>
    </form>
    <div class="page2-child1" ></div>

      <a class="dashboard-parent" href="dashboard">
        <div class="dashboard1">Dashboard</div>
        <img
          class="tabelu-de-bord-11"
          alt=""
          src="{% static 'images/tabelu de bord.png'%}"
        />
      </a>
      <a class="affichage-annuel-parent" href="traitement_annuel">
        <div class="affichage-annuel1">Affichage Annuel</div>
        <div class="frame-child"></div>
        <img
          class="traitement-de-linformation-1-icon2"
          alt=""
          src="{% static 'images/traitement-de-linformation.png'%}"
        />
      </a>
      <a class="affichage-p1-parent" href="traitement_p1">
        <div class="affichage-p11">Affichage P1</div>
        <div class="frame-item"></div>
        <img class="tabelu-de-bord-11" alt="" src="{% static 'images/bilan.png'%}" />
      </a>
      <a class="traitement-mensuel-parent"href="traitement_mansuel">
        <div class="traitement-mensuel1"> Traitement mensuel </div>
        <img
          class="traitement-de-linformation-1-icon3"
          alt=""
          src="{% static 'images/tabelu de bord.png' %}">
        />
      </a>
      <div class="line-icon" ></div>

      <div class="page2-child2" ></div>

      <b class="menu1">Menu</b>
      <img class="logo-icon" alt="" src="{% static 'images/logo.png'%}" />
    </div>
  </body>
  <script>
  
  function checkFile(file) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var content = e.target.result;
      var data = JSON.parse(content);
  
      for (var i = 0; i < data.length; i++) {
        var row = data[i];
        var perimetre_id = row.perimetre_id;
        var mois = row.mois;
        var annee = row.annee;
        var data = row.data;
  
        // Check if the element exists before setting its textContent
        var element = document.getElementById(perimetre_id + '-' + mois + '-' + annee);
        if (element) {
          element.textContent = 'Uncaught Error';
        }
      }
    };
    reader.readAsText(file);
  }function checkFile(file) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var content = e.target.result;
      var data = JSON.parse(content);
  
      for (var i = 0; i < data.length; i++) {
        var row = data[i];
        var perimetre_id = row.perimetre_id;
        var mois = row.mois;
        var annee = row.annee;
        var data = row.data;
  
        // Check if the element exists before setting its textContent
        var element = document.getElementById(perimetre_id + '-' + mois + '-' + annee);
        if (element) {
          element.textContent = 'Uncaught Error';
        }
      }
    };
    reader.readAsText(file);
  }

</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
   var error_message = "{{ error_message }}";
   var errorMessageSpan = document.querySelector('.error-message');
   var chooseFileLabel = document.querySelector('.choose-file-label');
   const chooseFileInput = document.querySelector(".choose-file-button");
 
   if (error_message) {
    chooseFileLabel.textContent = error_message;
   }
 
   chooseFileInput.addEventListener("change", () => {
    checkFile();
   });
 
   document.getElementById("upload-button").addEventListener("click", function (event) {
    event.preventDefault(); // Prevent default form submission
 
    // Ensure checkFile returns true for a valid file
    if (checkFile()) {
     document.getElementById("file-upload-form").submit();
    }
   });
 
   function checkFile() {
    var fileInput = chooseFileInput;
    var chooseFileLabel = document.querySelector('.choose-file-label');
    var errorMessageSpan = document.querySelector('.error-message');
 
    if (fileInput.files.length === 0) {
     chooseFileLabel.textContent = 'Veuillez sélectionner un fichier.';
     errorMessageSpan.textContent = 'Veuillez sélectionner un fichier.';
     return false; // Prevent submission
    } else {
     var fileName = fileInput.files[0].name;
     if (!fileName.endsWith('.xlsx')) {
      errorMessageSpan.textContent = 'Veuillez sélectionner un fichier Excel (.xlsx).';
      return false; // Prevent submission
     }
     chooseFileLabel.dataset.fileName = fileName;
     chooseFileLabel.textContent = fileName;
     fileInput.classList.remove("invalid");
     fileInput.classList.add("valid");
     errorMessageSpan.textContent = '';
     // Added this line to explicitly return true for valid files
     return true; // Allow submission
    }
   }
  });
 </script>


</html>
